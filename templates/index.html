<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insurance Chatbot â€” TMR Console</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #242836;
      --surface3: #2e3347;
      --border: #2d3142;
      --text: #e4e6eb;
      --text-dim: #8b8fa3;
      --text-muted: #5c6078;
      --accent: #6c5ce7;
      --accent-light: #a29bfe;
      --success: #00b894;
      --success-dim: rgba(0, 184, 148, 0.15);
      --danger: #e17055;
      --warning: #fdcb6e;
      --info: #74b9ff;
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .header-left h1 {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent-light);
      letter-spacing: -0.3px;
    }

    .new-chat-btn {
      padding: 6px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface2);
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .new-chat-btn:hover {
      border-color: var(--accent);
      color: var(--accent-light);
    }

    /* â”€â”€ Layout â”€â”€ */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* â”€â”€ Messages â”€â”€ */
    .msg {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.7;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.bot {
      align-self: flex-start;
      background: var(--surface2);
      border-bottom-left-radius: 4px;
    }

    .msg.bot.rendered { white-space: normal; }
    .msg.bot.rendered p { margin: 0 0 8px; }
    .msg.bot.rendered p:last-child { margin-bottom: 0; }
    .msg.bot.rendered ul, .msg.bot.rendered ol { margin: 4px 0 8px 18px; padding: 0; }
    .msg.bot.rendered li { margin-bottom: 2px; }
    .msg.bot.rendered h1,.msg.bot.rendered h2,.msg.bot.rendered h3 {
      font-size: 14px; font-weight: 600; margin: 10px 0 4px; color: var(--accent-light);
    }
    .msg.bot.rendered table {
      width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 13px;
    }
    .msg.bot.rendered th, .msg.bot.rendered td {
      padding: 6px 10px; border: 1px solid var(--border); text-align: left;
    }
    .msg.bot.rendered th { background: var(--surface3); font-weight: 600; }
    .msg.bot.rendered hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
    .msg.bot.rendered code { background: var(--surface3); padding: 1px 5px; border-radius: 4px; font-size: 13px; }
    .msg.bot.rendered strong { color: var(--accent-light); }

    .msg .meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .tag {
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag.tool {
      background: rgba(108, 92, 231, 0.15);
      border: 1px solid var(--accent);
      color: var(--accent-light);
    }

    .tag.rag {
      background: var(--success-dim);
      border: 1px solid var(--success);
      color: var(--success);
    }

    /* â”€â”€ Pipeline Status â”€â”€ */
    .pipeline-wrapper {
      align-self: flex-start;
      max-width: 95%;
      margin-bottom: 4px;
    }

    .pipeline-status {
      display: flex;
      align-items: center;
      padding: 12px 18px;
      background: var(--surface2);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
      gap: 0;
    }

    .pipeline-status .stage {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pipeline-status .stage .icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
      background: var(--surface3);
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .pipeline-status .stage .label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .pipeline-status .stage.active .icon {
      background: var(--accent);
      color: white;
      box-shadow: 0 0 10px rgba(108, 92, 231, 0.6);
      animation: icon-pulse 1.2s ease-in-out infinite;
    }
    .pipeline-status .stage.active .label {
      color: var(--accent-light);
      font-weight: 600;
    }

    .pipeline-status .stage.done .icon {
      background: var(--success);
      color: white;
    }
    .pipeline-status .stage.done .label { color: var(--success); }

    .pipeline-status .stage.skipped .icon {
      background: var(--surface3);
      color: var(--text-muted);
      opacity: 0.5;
    }
    .pipeline-status .stage.skipped .label {
      color: var(--text-muted);
      opacity: 0.5;
      text-decoration: line-through;
    }

    @keyframes icon-pulse {
      0%, 100% { box-shadow: 0 0 4px rgba(108, 92, 231, 0.3); }
      50%      { box-shadow: 0 0 14px rgba(108, 92, 231, 0.8); }
    }

    .pipeline-status .connector {
      width: 18px;
      height: 2px;
      background: var(--surface3);
      margin: 0 4px;
      flex-shrink: 0;
      transition: background 0.3s ease;
      border-radius: 1px;
    }
    .pipeline-status .connector.done { background: var(--success); }
    .pipeline-status .connector.skipped { background: var(--surface3); opacity: 0.5; }

    .tool-badge-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      padding: 6px 18px 0;
      align-items: center;
    }

    .tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(108, 92, 231, 0.12);
      border: 1px solid var(--accent);
      color: var(--accent-light);
      animation: badge-in 0.3s ease;
      transition: background 0.2s, border-color 0.2s;
    }

    .tool-badge.running {
      background: rgba(253, 203, 110, 0.15);
      border-color: var(--warning);
      color: var(--warning);
    }

    .tool-badge.done {
      background: rgba(0, 184, 148, 0.12);
      border-color: var(--success);
      color: var(--success);
    }

    .tool-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .tool-badge.running .dot {
      animation: dot-spin 1s linear infinite;
    }

    @keyframes dot-spin {
      0%   { opacity: 1; }
      50%  { opacity: 0.2; }
      100% { opacity: 1; }
    }

    @keyframes badge-in {
      from { opacity: 0; transform: translateY(-4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* â”€â”€ Example Queries â”€â”€ */
    .examples-section {
      padding: 8px 24px 0;
      flex-shrink: 0;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      overflow: hidden;
    }

    .examples-section.hidden {
      max-height: 0;
      opacity: 0;
      padding-top: 0;
      padding-bottom: 0;
      pointer-events: none;
    }

    .examples-header {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .example-groups {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .example-groups::-webkit-scrollbar { height: 4px; }
    .example-groups::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .example-group { flex-shrink: 0; }

    .example-group .group-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 5px;
      padding-left: 2px;
    }

    .example-group .group-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .example-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      white-space: nowrap;
    }

    .example-btn:hover {
      border-color: var(--accent);
      color: var(--accent-light);
      background: var(--surface3);
    }

    /* â”€â”€ Input â”€â”€ */
    .input-area {
      padding: 12px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .input-row { display: flex; gap: 10px; }

    .input-row input {
      flex: 1;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-row input:focus { border-color: var(--accent); }

    .input-row button {
      padding: 12px 28px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .input-row button:hover { background: var(--accent-light); }
    .input-row button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ Trace Panel â”€â”€ */
    .trace-panel {
      width: 360px;
      border-left: 1px solid var(--border);
      background: var(--surface);
      overflow-y: auto;
      padding: 16px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .trace-panel::-webkit-scrollbar { width: 5px; }
    .trace-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .trace-section h3 {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 700;
    }

    .tool-info-card {
      background: var(--surface2);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .tool-info-card .tool-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tool-info-card .tool-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(108, 92, 231, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .tool-info-card .tool-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-light);
    }

    .tool-info-card .tool-desc {
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .trace-item {
      background: var(--surface2);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      font-size: 12px;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }

    .trace-item:hover { border-color: var(--border); }

    .trace-item .node-name {
      font-weight: 700;
      color: var(--accent-light);
      font-size: 12px;
    }

    .trace-item .duration {
      color: var(--success);
      float: right;
      font-weight: 600;
      font-size: 11px;
    }

    .trace-item .detail {
      color: var(--text-dim);
      margin-top: 4px;
      font-size: 11px;
      line-height: 1.4;
    }

    .no-data {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
    }

    .streaming-cursor::after {
      content: '\2588';
      animation: blink 0.7s step-end infinite;
      color: var(--accent-light);
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* â”€â”€ Trace Toggle Button (mobile) â”€â”€ */
    .trace-toggle {
      display: none;
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface2);
      color: var(--text-dim);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      align-items: center;
      gap: 5px;
    }

    /* â”€â”€ Mobile Responsive â”€â”€ */
    @media (max-width: 768px) {
      header { padding: 8px 14px; gap: 6px; }
      .header-left h1 { font-size: 14px; }

      .trace-toggle { display: inline-flex; }

      .main-container { flex-direction: column; }

      .chat-panel { overflow-y: auto; }

      .trace-panel {
        display: none;
        width: 100%;
        border-left: none;
        border-top: 1px solid var(--border);
        max-height: 40vh;
        flex-shrink: 0;
      }
      .trace-panel.open { display: flex; }

      .messages {
        padding: 12px 10px;
        flex: 0 1 auto;
      }

      .msg { max-width: 92%; font-size: 13px; padding: 10px 12px; }

      .examples-section {
        padding: 6px 10px 0;
        flex-shrink: 0;
      }

      .example-groups {
        flex-direction: column;
        gap: 8px;
        overflow-x: visible;
      }

      .example-group { flex-shrink: 1; }

      .example-group .group-items {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 6px;
      }

      .example-btn {
        white-space: normal;
        font-size: 11px;
        padding: 6px 10px;
      }

      .input-area { padding: 8px 10px; }
      .input-row input { padding: 10px 12px; font-size: 13px; }
      .input-row button { padding: 10px 18px; font-size: 13px; }

      .pipeline-status { padding: 8px 10px; flex-wrap: wrap; gap: 2px; }
      .pipeline-status .stage .label { font-size: 11px; }
      .pipeline-status .connector { width: 12px; margin: 0 2px; }

      .tool-badge { font-size: 10px; padding: 3px 8px; }
      .tool-badge-bar { padding: 4px 10px 0; }
    }

    @media (max-width: 480px) {
      .msg { max-width: 95%; }
      .new-chat-btn span { display: none; }
      .catalog-btn span { display: none; }
      .trace-toggle span { display: none; }
      .catalog-btn { padding: 6px 8px; gap: 0; min-width: 0; }
      .trace-toggle { padding: 6px 8px; gap: 0; }
      .new-chat-btn { padding: 6px 8px; gap: 0; }
      header { padding: 8px 10px; gap: 4px; }
      header h1 { font-size: 13px; }

      .group-label { font-size: 9px !important; }
    }

    /* â”€â”€ Product Catalog Modal â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 1000; justify-content: center; align-items: center;
      padding: 12px;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; width: 720px; max-width: 100%; max-height: 85vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .modal-header {
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0;
    }
    .modal-header h2 { font-size: 15px; font-weight: 600; }
    .modal-close {
      background: none; border: none; color: var(--text-dim); font-size: 22px;
      cursor: pointer; padding: 4px 10px; border-radius: 6px;
      min-width: 36px; min-height: 36px; display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { background: var(--surface2); color: var(--text); }
    .modal-body { overflow-y: auto; padding: 12px 14px; -webkit-overflow-scrolling: touch; }
    .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .product-card {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 14px; cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .product-card:hover { border-color: var(--accent); background: var(--surface3); }
    .product-card:active { background: var(--surface3); }
    .product-card .pc-name { font-size: 13px; font-weight: 600; margin-bottom: 5px; line-height: 1.4; }
    .product-card .pc-meta {
      font-size: 11px; color: var(--text-dim);
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 5px; align-items: center;
    }
    .product-card .pc-tag {
      padding: 2px 7px; border-radius: 8px; font-size: 10px; font-weight: 500;
      white-space: nowrap;
    }
    .pc-tag.simplified { background: rgba(0,184,148,0.15); color: var(--success); }
    .pc-tag.category { background: rgba(108,92,231,0.15); color: var(--accent-light); }
    .pc-tag.renewal { background: rgba(253,203,110,0.15); color: var(--warning); }
    .product-card .pc-highlights {
      font-size: 12px; color: var(--text-dim); line-height: 1.5;
      padding-left: 16px; margin: 0;
    }
    .product-card .pc-highlights li { margin-bottom: 2px; }
    .catalog-btn {
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); padding: 6px 14px; border-radius: 8px;
      font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px;
      transition: border-color 0.2s; white-space: nowrap;
    }
    .catalog-btn:hover { border-color: var(--accent); color: var(--accent-light); }

    @media (max-width: 640px) {
      .modal-overlay { padding: 0; align-items: flex-end; }
      .modal-box {
        border-radius: 16px 16px 0 0; max-height: 75vh;
        width: 100%; max-width: 100%;
      }
      .modal-header { padding: 14px 16px; }
      .modal-header h2 { font-size: 14px; }
      .modal-body { padding: 6px 10px; }
      .product-grid { grid-template-columns: 1fr; gap: 0; }
      .product-card {
        border-radius: 0; border-left: none; border-right: none;
        border-top: none; padding: 11px 14px;
        background: transparent;
      }
      .product-card:last-child { border-bottom: none; }
      .product-card:active { background: var(--surface2); }
      .product-card .pc-name { font-size: 13px; margin-bottom: 3px; }
      .product-card .pc-meta { margin-bottom: 0; }
      .product-card .pc-highlights { display: none; }
      .product-card .pc-tag { font-size: 9px; padding: 1px 6px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>TMR Console</h1>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <a href="/admin/tools" target="_blank" class="catalog-btn" style="text-decoration:none" title="Tool Admin">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
        <span>Tool Admin</span>
      </a>
      <button class="catalog-btn" onclick="openProductModal()" title="ìƒí’ˆ ëª©ë¡">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><line x1="8" y1="3" x2="8" y2="21"/></svg>
        <span>ìƒí’ˆ ëª©ë¡</span>
      </button>
      <button class="trace-toggle" onclick="toggleTrace()" title="Trace">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <span>Trace</span>
      </button>
      <button class="new-chat-btn" onclick="newConversation()" title="ìƒˆ ëŒ€í™”">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <span>ìƒˆ ëŒ€í™”</span>
      </button>
    </div>
  </header>

  <div class="main-container">
    <div class="chat-panel">
      <div class="messages" id="messages">
        <div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë³´í—˜ ì¸ìˆ˜ì‹¬ì‚¬ ìƒë‹´ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ìƒí’ˆ ê°€ì… ì¡°ê±´, ë³‘ë ¥ í™•ì¸, ì§ì—… ìœ„í—˜ë„, ë©´ì±…/ê°ì•¡ ê¸°ê°„ ë“± ë³µì¡í•œ ì¸ìˆ˜ì‹¬ì‚¬ ì§ˆë¬¸ì— ë¹ ë¥´ê²Œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤.</div>
      </div>

      <div class="examples-section">
        <div class="examples-header">TMR ì‹¤ì „ ìƒë‹´ ì‹œë‚˜ë¦¬ì˜¤</div>
        <div class="example-groups">
          <div class="example-group">
            <div class="group-label" style="color:var(--danger)">ğŸ“ ê¸°ê°€ì… ê³ ê° ì•” ì§„ë‹¨ â†’ ì²­êµ¬ + ì¤‘ë³µë³´ì¥</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['ê³ ê° ê¹€ë¯¼ìˆ˜ë‹˜ ê³„ì•½ ì¡°íšŒí•´ì¤˜', 'ì´ ê³ ê°ì´ ê°‘ìƒì„ ì•” ì§„ë‹¨ë°›ì•˜ëŠ”ë° ê°€ì…ëœ ì•”ë³´í—˜ì—ì„œ ë³´í—˜ê¸ˆ ì²­êµ¬ ê°€ëŠ¥í•´?', 'ë³´í—˜ê¸ˆ ì²­êµ¬ ì ˆì°¨ë‘ í•„ìš” ì„œë¥˜ ì•Œë ¤ì¤˜', 'ì´ ê³ ê°í•œí…Œ ì¶”ê°€ë¡œ ê°€ì… ê°€ëŠ¥í•œ ë³´ì¥ ìƒí’ˆì´ ìˆì–´?'])">ê¹€ë¯¼ìˆ˜ ê³„ì•½ì¡°íšŒ â†’ ì•” ì§„ë‹¨ ì²­êµ¬ â†’ ì„œë¥˜ ì•ˆë‚´ â†’ ì¶”ê°€ë³´ì¥ ì¶”ì²œ</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--accent-light)">ğŸ“ ê¸°ê°€ì… ê³ ê° ì¶”ê°€ ìƒí’ˆ ì„¤ê³„</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['ê³ ê° ìœ¤ì§€ì€ë‹˜ ë³´ìœ  ê³„ì•½ í™•ì¸í•´ì¤˜', 'ì´ ê³ ê°ì´ ì¹˜ë§¤ ë³´ì¥ì„ ì¶”ê°€í•˜ê³  ì‹¶ëŒ€. í˜„ì¬ ë³´ìœ  ìƒí’ˆì´ë‘ ì¤‘ë³µ ì•ˆ ë˜ëŠ” ìƒí’ˆ ìˆì–´?', 'ì¹˜ë§¤ê°„ë³‘ë³´í—˜ì´ë‘ ì‹¤ì†ì¹˜ë§¤ë³´í—˜ ì°¨ì´ê°€ ë­ì•¼? 55ì„¸ ì—¬ì„± ê¸°ì¤€ ë³´í—˜ë£Œë„ ë¹„êµí•´ì¤˜', 'í˜„ì¬ ë³´ìœ  ìƒí’ˆ í•©ì‚°í•´ì„œ ì´ ì›” ë³´í—˜ë£Œ ì–¼ë§ˆë‚˜ ë¼?'])">ìœ¤ì§€ì€ ê³„ì•½í™•ì¸ â†’ ì¹˜ë§¤ë³´í—˜ ì¶”ì²œ â†’ ë¹„êµ â†’ í•©ì‚° ë³´í—˜ë£Œ</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--info)">ğŸ“ í•´ì§€ëœ ë³´í—˜ ë¶€í™œ + ëŒ€ì•ˆ ìƒí’ˆ</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['ê³ ê° ìµœìˆ˜ì§„ë‹˜ ê³„ì•½ í˜„í™© ì•Œë ¤ì¤˜', 'í•´ì§€ëœ ì•”ë³´í—˜ ë‹¤ì‹œ ë¶€í™œí•  ìˆ˜ ìˆì–´?', 'ë¶€í™œì´ ì•ˆ ë˜ë©´ 60ì„¸ ì—¬ì„±ì´ ê°€ì… ê°€ëŠ¥í•œ ì•”ë³´í—˜ì´ ìˆì–´?', 'í˜„ì¬ ìœ ì§€ ì¤‘ì¸ ì¢…ì‹ ë³´í—˜ ë³´ì¥ ë‚´ìš©ë„ í™•ì¸í•´ì¤˜'])">ìµœìˆ˜ì§„ ê³„ì•½í˜„í™© â†’ í•´ì§€ ë¶€í™œ â†’ ëŒ€ì•ˆ ì•”ë³´í—˜ â†’ ì¢…ì‹ ë³´í—˜ í™•ì¸</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--warning)">ğŸ“ ê³ ìœ„í—˜ ì§ì—… + ìœ ë³‘ë ¥ ë³µí•© ì‹¬ì‚¬</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['48ì„¸ ë‚¨ì„± ê³ ê°ì¸ë° íƒì‹œê¸°ì‚¬ì•¼. ê³ í˜ˆì•• ì•½ ë³µìš© ì¤‘ì´ê³  ì•”ë³´í—˜ ê°€ì…í•˜ê³  ì‹¶ëŒ€', 'ì´ ê³ ê° ì§ì—… ìœ„í—˜ë“±ê¸‰ ë¨¼ì € í™•ì¸í•´ì¤˜', 'ê·¸ëŸ¬ë©´ ì²«ë‚ ë¶€í„° ì•”ë³´í—˜ ê°€ì… ê°€ëŠ¥í•œ ì¡°ê±´ì´ ë­ì•¼? ê³ í˜ˆì••ì´ë©´ ê±°ì ˆë  ìˆ˜ ìˆì–´?', 'í˜¹ì‹œ ê°„í¸ì‹¬ì‚¬ë¡œ ê°€ì… ê°€ëŠ¥í•œ ê±´ê°•ë³´í—˜ë„ ìˆì–´?'])">íƒì‹œê¸°ì‚¬ + ê³ í˜ˆì•• â†’ ì§ì—…ë“±ê¸‰ â†’ ì•”ë³´í—˜ ì‹¬ì‚¬ â†’ ê°„í¸ì‹¬ì‚¬ ëŒ€ì•ˆ</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--success)">ğŸ“ ì‹œë‹ˆì–´ ì¢…í•© ì„¤ê³„ + ë³´í—˜ë£Œ ì‚°ì¶œ</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['70ì„¸ ì•„ë²„ì§€ì¸ë° ì‚¬ë§ë³´ì¥ì´ë‘ ì¹˜ì•„ë³´í—˜ ë‘˜ ë‹¤ ì•Œì•„ë³´ê³  ì‹¶ëŒ€', 'ê±´ê°•í•´ì§€ëŠ”ì¢…ì‹ ë³´í—˜ ë³´ì¥ ë‚´ìš©ì´ë‘ ì—°ê¸ˆì „í™˜ ì¡°ê±´ ì•Œë ¤ì¤˜', 'ë“ ë“ í•œì‹¤ë²„ì¹˜ì•„ë³´í—˜ì€ ì´ ë‚˜ì´ì— ê°€ì… ê°€ëŠ¥í•´? ë³´ì¥ ë²”ìœ„ëŠ”?', 'ë‘ ìƒí’ˆ í•©ì‚° ë³´í—˜ë£Œ ì–¼ë§ˆì¯¤ ë‚˜ì˜¬ê¹Œ?'])">ì‹œë‹ˆì–´ ì¢…í•©ì„¤ê³„ â†’ ì—°ê¸ˆì „í™˜ â†’ ê°€ì…ì¡°ê±´ â†’ í•©ì‚° ë³´í—˜ë£Œ</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:#e17055">ğŸ’¬ ë‹¨ê±´ ì§ˆë¬¸</div>
            <div class="group-items">
              <button class="example-btn" onclick="askExample(this)">ì†Œë°©ê´€ ê³ ê°ì¸ë° ì§ì—… ìœ„í—˜ë“±ê¸‰ ì–´ë–»ê²Œ ë¼?</button>
              <button class="example-btn" onclick="askExample(this)">í•´ì•½í™˜ê¸‰ê¸ˆ ë¯¸ì§€ê¸‰í˜•ì´ë©´ í•´ì•½ ì‹œ ëˆì„ ì•„ì˜ˆ ëª» ë°›ëŠ” ê±°ì•¼?</button>
              <button class="example-btn" onclick="askExample(this)">ë³´í—˜ ê³„ì•½ ì „ ì•Œë¦´ ì˜ë¬´ê°€ ë­ì•¼?</button>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-row">
          <input id="query-input" type="text"
                 placeholder="ì¸ìˆ˜ì‹¬ì‚¬ ì¡°ê±´, ë³‘ë ¥ í™•ì¸, ì§ì—… ìœ„í—˜ë„ ë“± ì§ˆë¬¸í•˜ì„¸ìš”..."
                 onkeydown="if(event.key==='Enter')sendMsg()">
          <button id="send-btn" onclick="sendMsg()">ì „ì†¡</button>
        </div>
      </div>
    </div>

    <div class="trace-panel">
      <div class="trace-section" id="tool-info-section">
        <h3>Selected Tool</h3>
        <div id="tool-info-content" class="no-data">ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ì„ íƒëœ ë„êµ¬ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
      <div class="trace-section">
        <h3>Pipeline Trace</h3>
        <div id="trace-items" class="no-data">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê³¼ì •ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- Product Catalog Modal -->
  <div class="modal-overlay" id="product-modal" onclick="if(event.target===this)closeProductModal()">
    <div class="modal-box">
      <div class="modal-header">
        <h2>íŒë§¤ ì¤‘ì¸ ìƒí’ˆ ëª©ë¡</h2>
        <button class="modal-close" onclick="closeProductModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="product-grid" id="product-grid">
          <div style="color:var(--text-dim)">ë¡œë”© ì¤‘...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* â”€â”€ Markdown ë Œë”ë§ â”€â”€ */
    function renderMd(text) {
      if (typeof marked !== 'undefined') {
        marked.setOptions({ breaks: true, gfm: true });
        return marked.parse(text || '');
      }
      return (text || '').replace(/\n/g, '<br>');
    }

    /* â”€â”€ Session / Thread ê´€ë¦¬ â”€â”€
     *  sessionId: ë¸Œë¼ìš°ì € íƒ­ ë‹¨ìœ„ (ìƒˆë¡œê³ ì¹¨ ì‹œ ë³€ê²½, ì„œë²„ ë¡œê¹…ìš©)
     *  threadId:  ëŒ€í™” ë‹¨ìœ„ â€” localStorageì— ì €ì¥í•´ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€.
     *             "ìƒˆ ëŒ€í™”" ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ìƒˆ UUIDë¡œ êµì²´.
     *  â†’ LangGraph SqliteSaverê°€ threadIdë¡œ ì´ì „ messagesë¥¼ ë³µì›
     */
    const sessionId = crypto.randomUUID();
    let threadId = localStorage.getItem('chatThreadId');
    if (!threadId) {
      threadId = crypto.randomUUID();
      localStorage.setItem('chatThreadId', threadId);
    }

    /* â”€â”€ ë„êµ¬ ë©”íƒ€ë°ì´í„°: ì„œë²„ì—ì„œ ë™ì  ë¡œë“œ â”€â”€ */
    const toolMeta = {};

    async function loadToolMeta() {
      try {
        const res = await fetch('/api/tools');
        const data = await res.json();
        (data.tools || []).forEach(t => {
          toolMeta[t.name] = {
            shortName: t.short_name || t.name,
            description: t.description,
          };
        });
      } catch { /* ë¡œë“œ ì‹¤íŒ¨í•´ë„ name ê·¸ëŒ€ë¡œ í‘œì‹œ */ }
    }

    function getToolDisplay(name) {
      return (toolMeta[name] && toolMeta[name].shortName) || name;
    }

    /* â”€â”€ ìƒí’ˆ ëª©ë¡ ëª¨ë‹¬ â”€â”€ */
    let productsCache = null;

    async function openProductModal() {
      document.getElementById('product-modal').classList.add('open');
      if (productsCache) { renderProducts(productsCache); return; }
      try {
        const res = await fetch('/api/products');
        const data = await res.json();
        productsCache = data.products || [];
        renderProducts(productsCache);
      } catch {
        document.getElementById('product-grid').innerHTML =
          '<div style="color:var(--danger)">ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('open');
    }

    function renderProducts(products) {
      const grid = document.getElementById('product-grid');
      grid.innerHTML = '';
      products.forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => {
          closeProductModal();
          document.getElementById('query-input').value = p.name + ' ë³´ì¥ ë‚´ìš© ì•Œë ¤ì¤˜';
          document.getElementById('query-input').focus();
        };
        const tags = [
          `<span class="pc-tag category">${p.category}</span>`,
          `<span class="pc-tag renewal">${p.renewal_type}</span>`,
        ];
        if (p.simplified) tags.push('<span class="pc-tag simplified">ê°„í¸ì‹¬ì‚¬</span>');
        card.innerHTML = `
          <div class="pc-name">${p.name}</div>
          <div class="pc-meta">${tags.join('')}<span>${p.age_range}</span></div>
          <ul class="pc-highlights">${p.highlights.map(h => `<li>${h}</li>`).join('')}</ul>
        `;
        grid.appendChild(card);
      });
    }

    /* â”€â”€ ìƒˆ ëŒ€í™” â”€â”€ */
    function newConversation() {
      threadId = crypto.randomUUID();
      localStorage.setItem('chatThreadId', threadId);
      const msgs = document.getElementById('messages');
      msgs.innerHTML = '<div class="msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë³´í—˜ ì¸ìˆ˜ì‹¬ì‚¬ ìƒë‹´ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ìƒí’ˆ ê°€ì… ì¡°ê±´, ë³‘ë ¥ í™•ì¸, ì§ì—… ìœ„í—˜ë„, ë©´ì±…/ê°ì•¡ ê¸°ê°„ ë“± ë³µì¡í•œ ì¸ìˆ˜ì‹¬ì‚¬ ì§ˆë¬¸ì— ë¹ ë¥´ê²Œ ë‹µë³€ë“œë¦½ë‹ˆë‹¤.</div>';
      document.getElementById('tool-info-content').innerHTML =
        '<span class="no-data">ì§ˆë¬¸ì„ ì…ë ¥í•˜ë©´ ì„ íƒëœ ë„êµ¬ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</span>';
      document.getElementById('trace-items').innerHTML =
        '<span class="no-data">íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê³¼ì •ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</span>';
      showExamples();
    }

    function askExample(el) {
      document.getElementById('query-input').value = el.textContent.trim();
      sendMsg();
    }

    /* ë©€í‹°í„´ ì‹œë‚˜ë¦¬ì˜¤: ì§ˆë¬¸ ë°°ì—´ì„ ìˆœì„œëŒ€ë¡œ ìë™ ì „ì†¡ */
    async function askSequence(queries) {
      for (const q of queries) {
        document.getElementById('query-input').value = q;
        sendMsg();
        /* ì´ì „ ì‘ë‹µì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° â€” send-btnì´ ë‹¤ì‹œ í™œì„±í™”ë˜ë©´ ì§„í–‰ */
        await new Promise(resolve => {
          const btn = document.getElementById('send-btn');
          const observer = new MutationObserver(() => {
            if (!btn.disabled) { observer.disconnect(); resolve(); }
          });
          observer.observe(btn, { attributes: true });
        });
        await new Promise(r => setTimeout(r, 400));
      }
    }

    /* â”€â”€ Pipeline Stages (ë°±ì—”ë“œ nodeâ†’stage ë§¤í•‘ê³¼ 1:1 ëŒ€ì‘) â”€â”€ */
    const STAGES = [
      { id: 'analyze',  label: 'ì§ˆë¬¸ ë¶„ì„',  icon: '1' },
      { id: 'execute',  label: 'ë„êµ¬ ì‹¤í–‰',  icon: '2' },
      { id: 'generate', label: 'ë‹µë³€ ìƒì„±',  icon: '3' },
    ];

    function hideExamples() {
      const sec = document.querySelector('.examples-section');
      if (sec) sec.classList.add('hidden');
      const msgs = document.querySelector('.messages');
      if (msgs) msgs.style.flex = '1';
    }

    function showExamples() {
      const sec = document.querySelector('.examples-section');
      if (sec) sec.classList.remove('hidden');
      const msgs = document.querySelector('.messages');
      if (msgs) msgs.style.flex = '';
    }

    /* â”€â”€ ë©”ì‹œì§€ ì „ì†¡ â”€â”€ */
    async function sendMsg() {
      const input = document.getElementById('query-input');
      const query = input.value.trim();
      if (!query) return;

      input.value = '';
      const btn = document.getElementById('send-btn');
      btn.disabled = true;
      hideExamples();

      appendMsg('user', query);

      const pipelineEl = createPipelineStatus();
      const botEl = appendMsg('bot', '', 'streaming-cursor');
      resetPanels();

      let tools_selected = [];
      let fullAnswer = '';
      let doneData = null;
      const activeBadges = {}; /* tool_name â†’ badge element */
      const startedStages = new Set();
      const completedStages = new Set();

      try {
        const res = await fetch('/api/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query,
            session_id: sessionId,
            thread_id: threadId,
          }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let currentEvent = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEvent = line.slice(7).trim();
            } else if (line.startsWith('data: ')) {
              let payload;
              try { payload = JSON.parse(line.slice(6)); } catch { continue; }

              switch (currentEvent) {
                case 'node_start':
                  startedStages.add(payload.node);
                  setStageActive(pipelineEl, payload.node);
                  break;
                case 'node_end':
                  completedStages.add(payload.node);
                  setStageComplete(pipelineEl, payload.node, payload.duration_ms);
                  break;
                case 'tools_selected':
                  tools_selected = [...new Set(payload.tools || [])];
                  showToolBadges(pipelineEl, tools_selected, activeBadges);
                  updateToolPanel(tools_selected);
                  break;
                case 'tool_start': {
                  const tname = payload.tool;
                  if (activeBadges[tname]) {
                    activeBadges[tname].classList.add('running');
                  } else {
                    /* tools_selected ë³´ë‹¤ tool_startê°€ ë¨¼ì € ì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„ */
                    addBadge(pipelineEl, tname, activeBadges, 'running');
                  }
                  break;
                }
                case 'tool_end': {
                  const tname = payload.tool;
                  const badge = activeBadges[tname];
                  if (badge) {
                    badge.classList.remove('running');
                    badge.classList.add('done');
                    if (payload.duration_ms != null) {
                      badge.title = `${Math.round(payload.duration_ms)}ms`;
                    }
                  }
                  break;
                }
                case 'token':
                  fullAnswer += payload.text;
                  botEl.textContent = fullAnswer;
                  botEl.classList.add('streaming-cursor');
                  scrollMessages();
                  break;
                case 'done':
                  doneData = payload;
                  break;
                case 'error':
                  fullAnswer = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (payload.error || '');
                  botEl.textContent = fullAnswer;
                  break;
              }
              currentEvent = '';
            }
          }
        }

        botEl.classList.remove('streaming-cursor');
        STAGES.forEach(s => {
          if (startedStages.has(s.id) && !completedStages.has(s.id)) {
            setStageComplete(pipelineEl, s.id);
          } else if (!startedStages.has(s.id)) {
            setStageSkipped(pipelineEl, s.id);
          }
        });

        if (doneData) {
          const finalText = (doneData.answer && doneData.answer !== fullAnswer)
            ? doneData.answer : fullAnswer;
          botEl.innerHTML = renderMd(finalText);
          botEl.classList.add('rendered');

          const allTools = [...new Set(doneData.tools_used || [])];
          if (allTools.length > 0) {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta';
            allTools.forEach(t => {
              metaDiv.innerHTML += `<span class="tag tool">${getToolDisplay(t)}</span>`;
            });
            botEl.appendChild(metaDiv);
          }

          updateToolPanel(allTools);
          renderTrace(doneData.trace || []);
        }
      } catch (e) {
        botEl.classList.remove('streaming-cursor');
        botEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message;
      }

      btn.disabled = false;
      input.focus();
    }

    /* â”€â”€ Pipeline Stepper â”€â”€ */

    function createPipelineStatus() {
      const wrapper = document.createElement('div');
      wrapper.className = 'pipeline-wrapper';

      const bar = document.createElement('div');
      bar.className = 'pipeline-status';

      STAGES.forEach((stage, i) => {
        const el = document.createElement('div');
        el.className = 'stage';
        el.dataset.stage = stage.id;
        el.innerHTML = `<span class="icon">${stage.icon}</span><span class="label">${stage.label}</span>`;
        bar.appendChild(el);
        if (i < STAGES.length - 1) {
          const conn = document.createElement('div');
          conn.className = 'connector';
          conn.dataset.after = stage.id;
          bar.appendChild(conn);
        }
      });

      wrapper.appendChild(bar);

      const badgeBar = document.createElement('div');
      badgeBar.className = 'tool-badge-bar';
      wrapper.appendChild(badgeBar);

      document.getElementById('messages').appendChild(wrapper);
      scrollMessages();
      return wrapper;
    }

    function setStageActive(wrapper, stageId) {
      const el = wrapper.querySelector(`[data-stage="${stageId}"]`);
      if (!el || el.classList.contains('done')) return;
      el.classList.add('active');
      scrollMessages();
    }

    function setStageComplete(wrapper, stageId, durationMs) {
      const el = wrapper.querySelector(`[data-stage="${stageId}"]`);
      if (!el) return;
      el.classList.remove('active');
      el.classList.add('done');

      const icon = el.querySelector('.icon');
      icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';

      if (durationMs != null) {
        const label = el.querySelector('.label');
        label.textContent += ` (${Math.round(durationMs)}ms)`;
      }

      const conn = wrapper.querySelector(`[data-after="${stageId}"]`);
      if (conn) conn.classList.add('done');
    }

    function setStageSkipped(wrapper, stageId) {
      const el = wrapper.querySelector(`[data-stage="${stageId}"]`);
      if (!el || el.classList.contains('done')) return;
      el.classList.remove('active');
      el.classList.add('skipped');

      const icon = el.querySelector('.icon');
      icon.innerHTML = 'â€”';

      const conn = wrapper.querySelector(`[data-after="${stageId}"]`);
      if (conn) conn.classList.add('skipped');
    }

    function showToolBadges(wrapper, tools, badgeMap) {
      const bar = wrapper.querySelector('.tool-badge-bar');
      if (!bar) return;
      bar.innerHTML = '';
      if (badgeMap) Object.keys(badgeMap).forEach(k => delete badgeMap[k]);
      tools.forEach(t => {
        const badge = _makeBadge(t);
        bar.appendChild(badge);
        if (badgeMap) badgeMap[t] = badge;
      });
      scrollMessages();
    }

    function addBadge(wrapper, toolName, badgeMap, cls) {
      const bar = wrapper.querySelector('.tool-badge-bar');
      if (!bar) return;
      const badge = _makeBadge(toolName, cls);
      bar.appendChild(badge);
      if (badgeMap) badgeMap[toolName] = badge;
      scrollMessages();
    }

    function _makeBadge(toolName, cls) {
      const badge = document.createElement('span');
      badge.className = 'tool-badge' + (cls ? ` ${cls}` : '');
      badge.innerHTML = `<span class="dot"></span>${getToolDisplay(toolName)}`;
      return badge;
    }

    /* â”€â”€ Right Panel â”€â”€ */

    function resetPanels() {
      document.getElementById('tool-info-content').innerHTML =
        '<span class="no-data">ë¶„ì„ ì¤‘...</span>';
      document.getElementById('trace-items').innerHTML =
        '<span class="no-data">ì‹¤í–‰ ì¤‘...</span>';
    }

    function updateToolPanel(tools) {
      const container = document.getElementById('tool-info-content');
      if (!tools || tools.length === 0) {
        container.innerHTML = '<span class="no-data">ë„êµ¬ ì‚¬ìš© ì—†ìŒ</span>';
        return;
      }
      container.innerHTML = '';
      tools.forEach(name => {
        const meta = toolMeta[name];
        const card = document.createElement('div');
        card.className = 'tool-info-card';
        card.innerHTML = `
          <div class="tool-main">
            <div class="tool-icon">${getCategoryIcon(name)}</div>
            <div>
              <div class="tool-name">${getToolDisplay(name)}</div>
              <div class="tool-desc">${name}</div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function getCategoryIcon(name) {
      const ic = (d) => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${d.c}" stroke-width="2">${d.p}</svg>`;
      if (name.startsWith('underwriting')) return ic({c:'var(--accent-light)', p:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>'});
      if (name.startsWith('product') || name.startsWith('rider')) return ic({c:'var(--info)', p:'<rect x="2" y="3" width="20" height="14" rx="2"/><line x1="12" y1="17" x2="12" y2="21"/>'});
      if (name.startsWith('premium') || name.startsWith('amount')) return ic({c:'var(--warning)', p:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'});
      if (name.startsWith('coverage') || name.startsWith('benefit')) return ic({c:'var(--success)', p:'<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>'});
      if (name.startsWith('claim')) return ic({c:'var(--danger)', p:'<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>'});
      if (name.startsWith('rag')) return ic({c:'var(--success)', p:'<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>'});
      return ic({c:'var(--text-dim)', p:'<circle cx="12" cy="12" r="10"/>'});
    }

    const TRACE_NODE_LABELS = {
      guard_input: 'ë³´í˜¸ í•„í„° (ì…ë ¥)',
      analyze: 'ì§ˆë¬¸ ë¶„ì„',
      execute: 'ë„êµ¬ ì‹¤í–‰',
      generate: 'ë‹µë³€ ìƒì„±',
      guard_output: 'ë³´í˜¸ í•„í„° (ì¶œë ¥)',
    };

    function renderTrace(trace) {
      const el = document.getElementById('trace-items');
      if (!trace || !trace.length) {
        el.innerHTML = '<span class="no-data">íŠ¸ë ˆì´ìŠ¤ ì—†ìŒ</span>';
        return;
      }
      el.innerHTML = '';
      trace.forEach(t => {
        const item = document.createElement('div');
        item.className = 'trace-item';
        const dur = t.duration_ms != null ? `${Math.round(t.duration_ms)}ms` : '';
        const displayName = TRACE_NODE_LABELS[t.node] || t.node;
        let detailStr = '';
        if (t.detail && typeof t.detail === 'object') {
          detailStr = Object.entries(t.detail)
            .map(([k, v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
            .join(' | ');
        }
        item.innerHTML = `
          <span class="node-name">${displayName}</span>
          <span class="duration">${dur}</span>
          ${detailStr ? `<div class="detail">${detailStr}</div>` : ''}
        `;
        el.appendChild(item);
      });
    }

    /* â”€â”€ DOM Helpers â”€â”€ */

    function appendMsg(cls, text, extraCls) {
      const div = document.createElement('div');
      div.className = `msg ${cls}` + (extraCls ? ` ${extraCls}` : '');
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
      scrollMessages();
      return div;
    }

    function scrollMessages() {
      const c = document.getElementById('messages');
      c.scrollTop = c.scrollHeight;
    }

    /* â”€â”€ Trace Panel Toggle (mobile) â”€â”€ */
    function toggleTrace() {
      const panel = document.querySelector('.trace-panel');
      panel.classList.toggle('open');
    }

    /* â”€â”€ Init â”€â”€ */
    loadToolMeta();
    openProductModal();
  </script>
</body>
</html>
