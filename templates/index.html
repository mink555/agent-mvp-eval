<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insurance Chatbot — TMR Console</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #242836;
      --surface3: #2e3347;
      --border: #2d3142;
      --text: #e4e6eb;
      --text-dim: #8b8fa3;
      --text-muted: #5c6078;
      --accent: #6c5ce7;
      --accent-light: #a29bfe;
      --success: #00b894;
      --success-dim: rgba(0, 184, 148, 0.15);
      --danger: #e17055;
      --warning: #fdcb6e;
      --info: #74b9ff;
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ── Header ── */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .header-left h1 {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent-light);
      letter-spacing: -0.3px;
    }

    .new-chat-btn {
      padding: 6px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface2);
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .new-chat-btn:hover {
      border-color: var(--accent);
      color: var(--accent-light);
    }

    /* ── Layout ── */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ── Messages ── */
    .msg {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 14px;
      line-height: 1.7;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--accent);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.bot {
      align-self: flex-start;
      background: var(--surface2);
      border-bottom-left-radius: 4px;
    }

    .msg .meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .tag {
      padding: 2px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tag.tool {
      background: rgba(108, 92, 231, 0.15);
      border: 1px solid var(--accent);
      color: var(--accent-light);
    }

    .tag.rag {
      background: var(--success-dim);
      border: 1px solid var(--success);
      color: var(--success);
    }

    /* ── Pipeline Status ── */
    .pipeline-wrapper {
      align-self: flex-start;
      max-width: 95%;
      margin-bottom: 4px;
    }

    .pipeline-status {
      display: flex;
      align-items: center;
      padding: 12px 18px;
      background: var(--surface2);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
      gap: 0;
    }

    .pipeline-status .stage {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .pipeline-status .stage .icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      flex-shrink: 0;
      background: var(--surface3);
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .pipeline-status .stage .label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .pipeline-status .stage.active .icon {
      background: var(--accent);
      color: white;
      box-shadow: 0 0 10px rgba(108, 92, 231, 0.6);
      animation: icon-pulse 1.2s ease-in-out infinite;
    }
    .pipeline-status .stage.active .label {
      color: var(--accent-light);
      font-weight: 600;
    }

    .pipeline-status .stage.done .icon {
      background: var(--success);
      color: white;
    }
    .pipeline-status .stage.done .label { color: var(--success); }

    @keyframes icon-pulse {
      0%, 100% { box-shadow: 0 0 4px rgba(108, 92, 231, 0.3); }
      50%      { box-shadow: 0 0 14px rgba(108, 92, 231, 0.8); }
    }

    .pipeline-status .connector {
      width: 18px;
      height: 2px;
      background: var(--surface3);
      margin: 0 4px;
      flex-shrink: 0;
      transition: background 0.3s ease;
      border-radius: 1px;
    }
    .pipeline-status .connector.done { background: var(--success); }

    .tool-badge-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      padding: 6px 18px 0;
      align-items: center;
    }

    .tool-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(108, 92, 231, 0.12);
      border: 1px solid var(--accent);
      color: var(--accent-light);
      animation: badge-in 0.3s ease;
      transition: background 0.2s, border-color 0.2s;
    }

    .tool-badge.running {
      background: rgba(253, 203, 110, 0.15);
      border-color: var(--warning);
      color: var(--warning);
    }

    .tool-badge.done {
      background: rgba(0, 184, 148, 0.12);
      border-color: var(--success);
      color: var(--success);
    }

    .tool-badge .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .tool-badge.running .dot {
      animation: dot-spin 1s linear infinite;
    }

    @keyframes dot-spin {
      0%   { opacity: 1; }
      50%  { opacity: 0.2; }
      100% { opacity: 1; }
    }

    @keyframes badge-in {
      from { opacity: 0; transform: translateY(-4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── Example Queries ── */
    .examples-section {
      padding: 8px 24px 0;
      flex-shrink: 0;
    }

    .examples-header {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .example-groups {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .example-groups::-webkit-scrollbar { height: 4px; }
    .example-groups::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .example-group { flex-shrink: 0; }

    .example-group .group-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      margin-bottom: 5px;
      padding-left: 2px;
    }

    .example-group .group-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .example-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      white-space: nowrap;
    }

    .example-btn:hover {
      border-color: var(--accent);
      color: var(--accent-light);
      background: var(--surface3);
    }

    /* ── Input ── */
    .input-area {
      padding: 12px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .input-row { display: flex; gap: 10px; }

    .input-row input {
      flex: 1;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .input-row input:focus { border-color: var(--accent); }

    .input-row button {
      padding: 12px 28px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .input-row button:hover { background: var(--accent-light); }
    .input-row button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ── Trace Panel ── */
    .trace-panel {
      width: 360px;
      border-left: 1px solid var(--border);
      background: var(--surface);
      overflow-y: auto;
      padding: 16px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .trace-panel::-webkit-scrollbar { width: 5px; }
    .trace-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .trace-section h3 {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 700;
    }

    .tool-info-card {
      background: var(--surface2);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .tool-info-card .tool-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tool-info-card .tool-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(108, 92, 231, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .tool-info-card .tool-name {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-light);
    }

    .tool-info-card .tool-desc {
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .trace-item {
      background: var(--surface2);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      font-size: 12px;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }

    .trace-item:hover { border-color: var(--border); }

    .trace-item .node-name {
      font-weight: 700;
      color: var(--accent-light);
      font-size: 12px;
    }

    .trace-item .duration {
      color: var(--success);
      float: right;
      font-weight: 600;
      font-size: 11px;
    }

    .trace-item .detail {
      color: var(--text-dim);
      margin-top: 4px;
      font-size: 11px;
      line-height: 1.4;
    }

    .no-data {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
    }

    .streaming-cursor::after {
      content: '\2588';
      animation: blink 0.7s step-end infinite;
      color: var(--accent-light);
    }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>TMR Console</h1>
    </div>
    <button class="new-chat-btn" onclick="newConversation()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"/>
        <line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      새 대화
    </button>
  </header>

  <div class="main-container">
    <div class="chat-panel">
      <div class="messages" id="messages">
        <div class="msg bot">안녕하세요! 보험 인수심사 상담 도우미입니다. 상품 가입 조건, 병력 확인, 직업 위험도, 면책/감액 기간 등 복잡한 인수심사 질문에 빠르게 답변드립니다.</div>
      </div>

      <div class="examples-section">
        <div class="examples-header">TMR 실전 질문 예시</div>
        <div class="example-groups">
          <div class="example-group">
            <div class="group-label" style="color:var(--danger)">인수심사</div>
            <div class="group-items">
              <button class="example-btn" onclick="askExample(this)">고혈압 약 복용 중인 55세 남성, 간편심사 암보험 가입 가능?</button>
              <button class="example-btn" onclick="askExample(this)">당뇨+고혈압 동시 보유 고객, 간편심사 통과 기준 알려줘</button>
              <button class="example-btn" onclick="askExample(this)">3년 전 디스크 수술, 치아보험 가입하면 부담보 조건은?</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--info)">상품/보험료</div>
            <div class="group-items">
              <button class="example-btn" onclick="askExample(this)">간편심사 암보험 상품 목록 알려줘</button>
              <button class="example-btn" onclick="askExample(this)">B00197011 보장 내용 요약해줘</button>
              <button class="example-btn" onclick="askExample(this)">45세 여성 치아보험 월 보험료 얼마야?</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--warning)">직업/특이 조건</div>
            <div class="group-items">
              <button class="example-btn" onclick="askExample(this)">배달기사인데 상해보험 가입 시 직업 제한 있어?</button>
              <button class="example-btn" onclick="askExample(this)">65세 고객 건강보험 최대 가입금액 얼마까지?</button>
              <button class="example-btn" onclick="askExample(this)">암보험 실효됐는데 부활 심사 시 면책기간 다시 적용?</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--success)">보장/면책 상세</div>
            <div class="group-items">
              <button class="example-btn" onclick="askExample(this)">치아보험 보장 개시 1년 내 충치 치료 받으면 얼마 나와?</button>
              <button class="example-btn" onclick="askExample(this)">재해 장해 특약 장해율별 지급 기준 알려줘</button>
              <button class="example-btn" onclick="askExample(this)">암 진단비 대기기간 90일 지나야 보장되나?</button>
            </div>
          </div>
          <div class="example-group">
            <div class="group-label" style="color:var(--accent-light)">멀티턴 테스트</div>
            <div class="group-items">
              <button class="example-btn" onclick="askSequence(['치아보험 상품 알려줘', '보험료는?', '30대 여성이면?'])">① 치아보험 → 보험료? → 30대 여성이면?</button>
              <button class="example-btn" onclick="askSequence(['간편심사 암보험 있어?', '55세 남성 가입 가능해?', '고혈압 있으면?'])">② 암보험 → 가입 가능? → 고혈압 있으면?</button>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-row">
          <input id="query-input" type="text"
                 placeholder="인수심사 조건, 병력 확인, 직업 위험도 등 질문하세요..."
                 onkeydown="if(event.key==='Enter')sendMsg()">
          <button id="send-btn" onclick="sendMsg()">전송</button>
        </div>
      </div>
    </div>

    <div class="trace-panel">
      <div class="trace-section" id="tool-info-section">
        <h3>Selected Tool</h3>
        <div id="tool-info-content" class="no-data">질문을 입력하면 선택된 도구 정보가 표시됩니다.</div>
      </div>
      <div class="trace-section">
        <h3>Pipeline Trace</h3>
        <div id="trace-items" class="no-data">파이프라인 실행 과정이 여기에 표시됩니다.</div>
      </div>
    </div>
  </div>

  <script>
    /* ── Session / Thread 관리 ──
     *  sessionId: 브라우저 탭 단위 (새로고침 시 변경, 서버 로깅용)
     *  threadId:  대화 단위 — localStorage에 저장해 새로고침 후에도 유지.
     *             "새 대화" 버튼 클릭 시에만 새 UUID로 교체.
     *  → LangGraph SqliteSaver가 threadId로 이전 messages를 복원
     */
    const sessionId = crypto.randomUUID();
    let threadId = localStorage.getItem('chatThreadId');
    if (!threadId) {
      threadId = crypto.randomUUID();
      localStorage.setItem('chatThreadId', threadId);
    }

    /* ── 도구 메타데이터: 서버에서 동적 로드 ── */
    const toolMeta = {};

    async function loadToolMeta() {
      try {
        const res = await fetch('/api/tools');
        const data = await res.json();
        (data.tools || []).forEach(t => {
          toolMeta[t.name] = {
            shortName: t.short_name || t.name,
            description: t.description,
          };
        });
      } catch { /* 로드 실패해도 name 그대로 표시 */ }
    }

    function getToolDisplay(name) {
      return (toolMeta[name] && toolMeta[name].shortName) || name;
    }

    /* ── 새 대화 ── */
    function newConversation() {
      threadId = crypto.randomUUID();
      localStorage.setItem('chatThreadId', threadId);
      const msgs = document.getElementById('messages');
      msgs.innerHTML = '<div class="msg bot">안녕하세요! 보험 인수심사 상담 도우미입니다. 상품 가입 조건, 병력 확인, 직업 위험도, 면책/감액 기간 등 복잡한 인수심사 질문에 빠르게 답변드립니다.</div>';
      document.getElementById('tool-info-content').innerHTML =
        '<span class="no-data">질문을 입력하면 선택된 도구 정보가 표시됩니다.</span>';
      document.getElementById('trace-items').innerHTML =
        '<span class="no-data">파이프라인 실행 과정이 여기에 표시됩니다.</span>';
    }

    function askExample(el) {
      document.getElementById('query-input').value = el.textContent.trim();
      sendMsg();
    }

    /* 멀티턴 시나리오: 질문 배열을 순서대로 자동 전송 */
    async function askSequence(queries) {
      for (const q of queries) {
        document.getElementById('query-input').value = q;
        sendMsg();
        /* 이전 응답이 완료될 때까지 대기 — send-btn이 다시 활성화되면 진행 */
        await new Promise(resolve => {
          const btn = document.getElementById('send-btn');
          const observer = new MutationObserver(() => {
            if (!btn.disabled) { observer.disconnect(); resolve(); }
          });
          observer.observe(btn, { attributes: true });
        });
        await new Promise(r => setTimeout(r, 400));
      }
    }

    /* ── Pipeline Stages (백엔드 node→stage 매핑과 1:1 대응) ── */
    const STAGES = [
      { id: 'analyze',  label: '질문 분석',  icon: '1' },
      { id: 'execute',  label: '도구 실행',  icon: '2' },
      { id: 'generate', label: '답변 생성',  icon: '3' },
    ];

    /* ── 메시지 전송 ── */
    async function sendMsg() {
      const input = document.getElementById('query-input');
      const query = input.value.trim();
      if (!query) return;

      input.value = '';
      const btn = document.getElementById('send-btn');
      btn.disabled = true;

      appendMsg('user', query);

      const pipelineEl = createPipelineStatus();
      const botEl = appendMsg('bot', '', 'streaming-cursor');
      resetPanels();

      let tools_selected = [];
      let fullAnswer = '';
      let doneData = null;
      const activeBadges = {}; /* tool_name → badge element */

      try {
        const res = await fetch('/api/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query,
            session_id: sessionId,
            thread_id: threadId,
          }),
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let currentEvent = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('event: ')) {
              currentEvent = line.slice(7).trim();
            } else if (line.startsWith('data: ')) {
              let payload;
              try { payload = JSON.parse(line.slice(6)); } catch { continue; }

              switch (currentEvent) {
                case 'node_start':
                  setStageActive(pipelineEl, payload.node);
                  break;
                case 'node_end':
                  setStageComplete(pipelineEl, payload.node, payload.duration_ms);
                  break;
                case 'tools_selected':
                  tools_selected = payload.tools || [];
                  showToolBadges(pipelineEl, tools_selected, activeBadges);
                  updateToolPanel(tools_selected);
                  break;
                case 'tool_start': {
                  const tname = payload.tool;
                  if (activeBadges[tname]) {
                    activeBadges[tname].classList.add('running');
                  } else {
                    /* tools_selected 보다 tool_start가 먼저 오는 경우 대비 */
                    addBadge(pipelineEl, tname, activeBadges, 'running');
                  }
                  break;
                }
                case 'tool_end': {
                  const tname = payload.tool;
                  const badge = activeBadges[tname];
                  if (badge) {
                    badge.classList.remove('running');
                    badge.classList.add('done');
                    if (payload.duration_ms != null) {
                      badge.title = `${Math.round(payload.duration_ms)}ms`;
                    }
                  }
                  break;
                }
                case 'token':
                  fullAnswer += payload.text;
                  botEl.textContent = fullAnswer;
                  botEl.classList.add('streaming-cursor');
                  scrollMessages();
                  break;
                case 'done':
                  doneData = payload;
                  break;
                case 'error':
                  fullAnswer = '오류가 발생했습니다: ' + (payload.error || '');
                  botEl.textContent = fullAnswer;
                  break;
              }
              currentEvent = '';
            }
          }
        }

        botEl.classList.remove('streaming-cursor');
        STAGES.forEach(s => setStageComplete(pipelineEl, s.id));

        if (doneData) {
          if (doneData.answer && doneData.answer !== fullAnswer) {
            botEl.textContent = doneData.answer;
          }

          const allTools = doneData.tools_used || [];
          if (allTools.length > 0 || doneData.rag_used) {
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta';
            allTools.forEach(t => {
              metaDiv.innerHTML += `<span class="tag tool">${getToolDisplay(t)}</span>`;
            });
            if (doneData.rag_used) {
              metaDiv.innerHTML += `<span class="tag rag">RAG</span>`;
            }
            botEl.appendChild(metaDiv);
          }

          if (allTools.length > 0) updateToolPanel(allTools);
          renderTrace(doneData.trace || []);
        }
      } catch (e) {
        botEl.classList.remove('streaming-cursor');
        botEl.textContent = '오류가 발생했습니다: ' + e.message;
      }

      btn.disabled = false;
      input.focus();
    }

    /* ── Pipeline Stepper ── */

    function createPipelineStatus() {
      const wrapper = document.createElement('div');
      wrapper.className = 'pipeline-wrapper';

      const bar = document.createElement('div');
      bar.className = 'pipeline-status';

      STAGES.forEach((stage, i) => {
        const el = document.createElement('div');
        el.className = 'stage';
        el.dataset.stage = stage.id;
        el.innerHTML = `<span class="icon">${stage.icon}</span><span class="label">${stage.label}</span>`;
        bar.appendChild(el);
        if (i < STAGES.length - 1) {
          const conn = document.createElement('div');
          conn.className = 'connector';
          conn.dataset.after = stage.id;
          bar.appendChild(conn);
        }
      });

      wrapper.appendChild(bar);

      const badgeBar = document.createElement('div');
      badgeBar.className = 'tool-badge-bar';
      wrapper.appendChild(badgeBar);

      document.getElementById('messages').appendChild(wrapper);
      scrollMessages();
      return wrapper;
    }

    function setStageActive(wrapper, stageId) {
      const el = wrapper.querySelector(`[data-stage="${stageId}"]`);
      if (!el || el.classList.contains('done')) return;
      el.classList.add('active');
      scrollMessages();
    }

    function setStageComplete(wrapper, stageId, durationMs) {
      const el = wrapper.querySelector(`[data-stage="${stageId}"]`);
      if (!el) return;
      el.classList.remove('active');
      el.classList.add('done');

      const icon = el.querySelector('.icon');
      icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>';

      if (durationMs != null) {
        const label = el.querySelector('.label');
        label.textContent += ` (${Math.round(durationMs)}ms)`;
      }

      const conn = wrapper.querySelector(`[data-after="${stageId}"]`);
      if (conn) conn.classList.add('done');
    }

    function showToolBadges(wrapper, tools, badgeMap) {
      const bar = wrapper.querySelector('.tool-badge-bar');
      if (!bar) return;
      bar.innerHTML = '';
      if (badgeMap) Object.keys(badgeMap).forEach(k => delete badgeMap[k]);
      tools.forEach(t => {
        const badge = _makeBadge(t);
        bar.appendChild(badge);
        if (badgeMap) badgeMap[t] = badge;
      });
      scrollMessages();
    }

    function addBadge(wrapper, toolName, badgeMap, cls) {
      const bar = wrapper.querySelector('.tool-badge-bar');
      if (!bar) return;
      const badge = _makeBadge(toolName, cls);
      bar.appendChild(badge);
      if (badgeMap) badgeMap[toolName] = badge;
      scrollMessages();
    }

    function _makeBadge(toolName, cls) {
      const badge = document.createElement('span');
      badge.className = 'tool-badge' + (cls ? ` ${cls}` : '');
      badge.innerHTML = `<span class="dot"></span>${getToolDisplay(toolName)}`;
      return badge;
    }

    /* ── Right Panel ── */

    function resetPanels() {
      document.getElementById('tool-info-content').innerHTML =
        '<span class="no-data">분석 중...</span>';
      document.getElementById('trace-items').innerHTML =
        '<span class="no-data">실행 중...</span>';
    }

    function updateToolPanel(tools) {
      const container = document.getElementById('tool-info-content');
      if (!tools || tools.length === 0) {
        container.innerHTML = '<span class="no-data">도구 사용 없음</span>';
        return;
      }
      container.innerHTML = '';
      tools.forEach(name => {
        const meta = toolMeta[name];
        const card = document.createElement('div');
        card.className = 'tool-info-card';
        card.innerHTML = `
          <div class="tool-main">
            <div class="tool-icon">${getCategoryIcon(name)}</div>
            <div>
              <div class="tool-name">${getToolDisplay(name)}</div>
              <div class="tool-desc">${name}</div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function getCategoryIcon(name) {
      const ic = (d) => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${d.c}" stroke-width="2">${d.p}</svg>`;
      if (name.startsWith('underwriting')) return ic({c:'var(--accent-light)', p:'<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>'});
      if (name.startsWith('product') || name.startsWith('rider')) return ic({c:'var(--info)', p:'<rect x="2" y="3" width="20" height="14" rx="2"/><line x1="12" y1="17" x2="12" y2="21"/>'});
      if (name.startsWith('premium') || name.startsWith('amount')) return ic({c:'var(--warning)', p:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'});
      if (name.startsWith('coverage') || name.startsWith('benefit')) return ic({c:'var(--success)', p:'<polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>'});
      if (name.startsWith('claim')) return ic({c:'var(--danger)', p:'<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>'});
      if (name.startsWith('rag')) return ic({c:'var(--success)', p:'<circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>'});
      return ic({c:'var(--text-dim)', p:'<circle cx="12" cy="12" r="10"/>'});
    }

    function renderTrace(trace) {
      const el = document.getElementById('trace-items');
      if (!trace || !trace.length) {
        el.innerHTML = '<span class="no-data">트레이스 없음</span>';
        return;
      }
      el.innerHTML = '';
      trace.forEach(t => {
        const item = document.createElement('div');
        item.className = 'trace-item';
        const dur = t.duration_ms != null ? `${Math.round(t.duration_ms)}ms` : '';
        let detailStr = '';
        if (t.detail && typeof t.detail === 'object') {
          detailStr = Object.entries(t.detail)
            .map(([k, v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
            .join(' | ');
        }
        item.innerHTML = `
          <span class="node-name">${t.node}</span>
          <span class="duration">${dur}</span>
          ${detailStr ? `<div class="detail">${detailStr}</div>` : ''}
        `;
        el.appendChild(item);
      });
    }

    /* ── DOM Helpers ── */

    function appendMsg(cls, text, extraCls) {
      const div = document.createElement('div');
      div.className = `msg ${cls}` + (extraCls ? ` ${extraCls}` : '');
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
      scrollMessages();
      return div;
    }

    function scrollMessages() {
      const c = document.getElementById('messages');
      c.scrollTop = c.scrollHeight;
    }

    /* ── Init ── */
    loadToolMeta();
  </script>
</body>
</html>
